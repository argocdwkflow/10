Oui, je vois pourquoi ça t’a posé le repo standard : ton test “CPE” est basé sur ansible_facts.domain, et sur certains hosts (ou avec gather_subset minimal) ansible_facts.domain / ansible_facts.fqdn peut être vide ⇒ bp2i_is_cpe=false ⇒ profil standard.
Voici uniquement ce qu’il faut modifier pour que la détection CPE se fasse sur le FQDN réel (et marche même si les facts DNS sont incomplets).
✅ 1) S’assurer d’avoir fqdn/domain (facts network)
Dans ton task “Ensure minimal facts…”, remplace/ajoute pour récupérer au moins les facts réseau :
Copy code
Yaml
- name: Ensure network facts are available (fqdn/domain)
  ansible.builtin.setup:
    gather_subset:
      - min
      - network
  when: ansible_facts is not defined
        or ansible_facts.fqdn is not defined
        or ansible_facts.domain is not defined
(network est la clé ici.)
✅ 2) Calculer bp2i_is_cpe sur le FQDN (pas sur domain)
Dans “Compute hostname/domain and CPE flag”, remplace ton calcul par :
Copy code
Yaml
- name: Compute hostname/fqdn and CPE flag
  ansible.builtin.set_fact:
    bp2i_fqdn: "{{ (ansible_facts.fqdn | default(inventory_hostname)) | lower }}"
    bp2i_is_cpe: >-
      {{
        bp2i_fqdn.endswith(bp2itools_cpe_suffix | lower)
        or bp2i_fqdn.endswith('.' ~ (bp2itools_cpe_suffix | lower))
      }}
✅ Comme ça, ça marche si :
ton suffix est cpe.intra
ou si tu veux matcher .cpe.intra
✅ 3) (Optionnel mais conseillé) Debug rapide pour valider
Ajoute temporairement :
Copy code
Yaml
- ansible.builtin.debug:
    msg:
      - "fqdn={{ bp2i_fqdn }}"
      - "cpe_suffix={{ bp2itools_cpe_suffix }}"
      - "is_cpe={{ bp2i_is_cpe }}"
  when: bp2itools_debug | bool
Résultat attendu
Si le host est xxx.cpe.intra, bp2i_is_cpe devient true ⇒ le rôle choisit bp2itools_cpe.
Si tu veux, je te propose aussi une version “fallback” qui utilise hostname -f si le DNS/facts sont cassés (mais là déjà, avec network + fqdn.endswith(), tu vas corriger ton cas).