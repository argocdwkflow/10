OK — voici uniquement les actions à modifier dans ton rôle (ciblées sur l’erreur [Errno 28] No space left on device).
1) Remplacer l’action “Clean yum / dnf cache”
❌ Actuel
Copy code
Yaml
- name: "Clean yum / dnf cache"
  ansible.builtin.shell: |
    rm -rf /var/cache/{{ ansible_pkg_mgr | default("bad_path") }}/*
✅ Nouveau
Copy code
Yaml
- name: Clean yum/dnf cache safely
  ansible.builtin.command: "{{ ansible_pkg_mgr }} clean all"
  changed_when: true
2) Ajouter juste avant “Refresh dnf / yum cache” une vérif espace /var
Copy code
Yaml
- name: Check free space on /var (KB)
  ansible.builtin.command: df -Pk /var
  register: var_df
  changed_when: false

- name: Set free space fact
  ansible.builtin.set_fact:
    var_free_kb: "{{ var_df.stdout_lines[-1].split()[3] | int }}"

- name: Fail if /var has less than 500MB free
  ansible.builtin.fail:
    msg: "/var is almost full ({{ var_free_kb }} KB free) - cannot run yum/dnf makecache"
  when: var_free_kb < 512000
3) Modifier l’action “Refresh dnf / yum cache” (ne plus faire un retry bloquant)
❌ Actuel
Copy code
Yaml
- name: "Refresh dnf / yum cache"
  ansible.builtin.shell: |
    {{ ansible_pkg_mgr }} makecache
  register: _makecache
  until: _makecache is success
  retries: 3
  delay: 10
  timeout: 300
✅ Nouveau
Copy code
Yaml
- name: Refresh yum/dnf cache
  ansible.builtin.command: "{{ ansible_pkg_mgr }} makecache"
  register: makecache
  failed_when: false
  changed_when: false
(optionnel mais utile)
Copy code
Yaml
- name: Warn if makecache failed
  ansible.builtin.debug:
    msg: "WARNING: {{ ansible_pkg_mgr }} makecache failed (rc={{ makecache.rc }}). Check /var space."
  when: makecache.rc != 0
✅ Avec ces 3 modifications, ton rôle ne tombera plus en erreur “Satellite register failed” alors que le vrai problème est /var plein, et tu auras un message clair et actionnable.