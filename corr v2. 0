Je vois ton bloc ğŸ‘. LÃ  tu as 2 erreurs dans ce que tu as Ã©crit :
Tu dÃ©finis bp2i_fqdn et tu lâ€™utilises dans la mÃªme task pour calculer bp2i_is_cpe â†’ Ã§a peut donner â€œundefinedâ€.
Tu as un mix de noms : tu calcules bp2i_is_cpe mais plus bas tu utilises bp2i_is_cpe / bp2i_is_cpe (il faut un seul nom partout).
âœ… Modif minimale Ã  faire (copier/coller)
ğŸ”§ Remplacer ton task â€œCompute hostname/fqdn and CPE flagâ€ par 2 tasks
Copy code
Yaml
- name: Compute hostname/fqdn
  ansible.builtin.set_fact:
    bp2i_fqdn: "{{ (ansible_facts.fqdn | default(inventory_hostname)) | lower }}"

- name: Compute CPE flag
  ansible.builtin.set_fact:
    bp2i_is_cpe: >-
      {{
        bp2i_fqdn.endswith(bp2itools_cpe_suffix | lower)
        or bp2i_fqdn.endswith('.' ~ (bp2itools_cpe_suffix | lower))
      }}
âœ… Et corriger ensuite lâ€™utilisation (1 seule variable)
Dans â€œSelect repo profileâ€¦â€, garde Ã§a (câ€™est bon) :
Copy code
Yaml
bp2itools_repo_name: "{{ (bp2i_is_cpe | bool) | ternary(bp2itools_cpe.name, bp2itools_standard.name) }}"
bp2itools_repo_baseurls: "{{ (bp2i_is_cpe | bool) | ternary(bp2itools_cpe.baseurls, bp2itools_standard.baseurls) }}"
Et dans ton debug, pareil :
Copy code
Yaml
- ansible.builtin.debug:
    msg:
      - "fqdn={{ bp2i_fqdn }}"
      - "cpe_suffix={{ bp2itools_cpe_suffix }}"
      - "is_cpe={{ bp2i_is_cpe }}"
  when: bp2itools_debug | bool
âœ… RÃ©sultat
Si le host est xxxx.cpe.intra, alors bp2i_is_cpe=true â‡’ ton rÃ´le dÃ©posera le repo CPE.
Si aprÃ¨s Ã§a il met encore â€œstandardâ€, la prochaine chose Ã  vÃ©rifier câ€™est la valeur rÃ©elle de ansible_facts.fqdn vs inventory_hostname (le debug ci-dessus te le dira immÃ©diatement).