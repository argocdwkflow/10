Voilà une structure prête pour AAP / Ansible (un rôle) qui :
vérifie si /etc/yum.repos.d/bp2itools.repo existe et est non vide
sinon, il déploie le fichier repo bp2itools.repo sur le serveur
(optionnel) peut faire un dnf/yum clean metadata après ajout
Arborescence du rôle
Copy code

roles/
  bp2itools_repo/
    collections/
      requirements.txt
    defaults/
      main.yml
    files/
      bp2itools.repo
    meta/
      main.yml
    tasks/
      main.yml
1) collections/requirements.txt
Si ton rôle utilise seulement les modules built-in Ansible, tu peux laisser minimal.
Copy code
Txt
# collections/requirements.txt
---
collections:
  - name: ansible.builtin
2) defaults/main.yml
Copy code
Yaml
---
bp2itools_repo_path: "/etc/yum.repos.d/bp2itools.repo"

# Nom du fichier repo dans le rôle
bp2itools_repo_src: "bp2itools.repo"

# Propriétaire / droits
bp2itools_repo_owner: "root"
bp2itools_repo_group: "root"
bp2itools_repo_mode: "0644"

# Optionnel: nettoyer le cache après ajout/modif
bp2itools_clean_metadata: true
3) meta/main.yml
Copy code
Yaml
---
galaxy_info:
  role_name: bp2itools_repo
  author: "your-team"
  description: "Ensure bp2itools yum repo file exists and is not empty"
  license: "proprietary"
  min_ansible_version: "2.14"

  platforms:
    - name: EL
      versions:
        - "7"
        - "8"
        - "9"

dependencies: []
4) files/bp2itools.repo
➡️ Mets ici ton vrai contenu (URL, gpgkey, etc.). Exemple générique :
Copy code
Ini
[bp2itools]
name=BP2I Tools Repository
baseurl=http://your.repo.server/bp2itools/$releasever/os/$basearch/
enabled=1
gpgcheck=0
(Si tu as GPG, je te conseille gpgcheck=1 + gpgkey=....)
5) tasks/main.yml
Copy code
Yaml
---
- name: "Check if bp2itools repo file exists"
  ansible.builtin.stat:
    path: "{{ bp2itools_repo_path }}"
  register: bp2itools_repo_stat

- name: "Check repo file is non-empty (if exists)"
  ansible.builtin.slurp:
    path: "{{ bp2itools_repo_path }}"
  register: bp2itools_repo_slurp
  when: bp2itools_repo_stat.stat.exists

- name: "Decide if we must deploy repo (missing or empty)"
  ansible.builtin.set_fact:
    bp2itools_repo_need_deploy: >-
      {{
        (not bp2itools_repo_stat.stat.exists)
        or
        (
          bp2itools_repo_stat.stat.exists
          and
          (
            (bp2itools_repo_stat.stat.size | default(0) | int) == 0
            or
            (
              (bp2itools_repo_slurp.content | default('') | b64decode | trim) == ''
            )
          )
        )
      }}

- name: "Deploy bp2itools.repo when needed"
  ansible.builtin.copy:
    src: "{{ bp2itools_repo_src }}"
    dest: "{{ bp2itools_repo_path }}"
    owner: "{{ bp2itools_repo_owner }}"
    group: "{{ bp2itools_repo_group }}"
    mode: "{{ bp2itools_repo_mode }}"
  when: bp2itools_repo_need_deploy
  register: bp2itools_repo_copy

- name: "Clean yum/dnf metadata if repo deployed/changed"
  ansible.builtin.command: "{{ item }}"
  changed_when: false
  loop:
    - "dnf -q clean metadata"
    - "yum -q clean metadata"
  when:
    - bp2itools_clean_metadata | bool
    - bp2itools_repo_copy is defined
    - bp2itools_repo_copy.changed
  failed_when: false
✅ Ce rôle est idempotent : il ne touche rien si le fichier existe et contient déjà quelque chose.
✅ Il marche RHEL7/8/9 : dnf peut ne pas exister sur RHEL7, donc on exécute les deux en failed_when: false.
Exemple d’utilisation dans un playbook
Copy code
Yaml
- hosts: all
  become: true
  roles:
    - role: bp2itools_repo
Si tu veux, je peux aussi te donner :
une version template (Jinja2) du .repo avec variables (baseurl, enabled, gpgcheck…),
un handler pour nettoyer le cache uniquement si changement,
ou une intégration typique dans un projet AAP (structure Git + inventories + job template).


-----


Parfait — voici la version template Jinja2 + handler (nettoyage cache uniquement si le repo change).
Arborescence (mise à jour)
Copy code

roles/
  bp2itools_repo/
    defaults/main.yml
    handlers/main.yml
    meta/main.yml
    tasks/main.yml
    templates/
      bp2itools.repo.j2
(tu peux supprimer files/bp2itools.repo si tu passes full template)
defaults/main.yml (avec variables repo)
Copy code
Yaml
---
bp2itools_repo_path: "/etc/yum.repos.d/bp2itools.repo"

# repo section name
bp2itools_repo_id: "bp2itools"

bp2itools_repo_name: "BP2I Tools Repository"
bp2itools_repo_baseurl: "http://your.repo.server/bp2itools/$releasever/os/$basearch/"
bp2itools_repo_enabled: 1

# sécurité
bp2itools_repo_gpgcheck: 0
bp2itools_repo_gpgkey: ""   # ex: "http://your.repo.server/RPM-GPG-KEY-bp2i"

# options utiles (facultatif)
bp2itools_repo_sslverify: true
bp2itools_repo_proxy: ""          # ex: "http://proxy:3128" ou vide
bp2itools_repo_exclude: ""        # ex: "bp2itools-badpkg*"
bp2itools_repo_priority: ""       # ex: 10 (nécessite yum-plugin-priorities sur RHEL7)

# fichier
bp2itools_repo_owner: "root"
bp2itools_repo_group: "root"
bp2itools_repo_mode: "0644"
templates/bp2itools.repo.j2
Copy code
Ini
[{{ bp2itools_repo_id }}]
name={{ bp2itools_repo_name }}
baseurl={{ bp2itools_repo_baseurl }}
enabled={{ bp2itools_repo_enabled }}
gpgcheck={{ bp2itools_repo_gpgcheck }}

{% if bp2itools_repo_gpgcheck | int == 1 and (bp2itools_repo_gpgkey | trim) != "" -%}
gpgkey={{ bp2itools_repo_gpgkey }}
{% endif -%}

{% if bp2itools_repo_exclude | trim != "" -%}
exclude={{ bp2itools_repo_exclude }}
{% endif -%}

{% if bp2itools_repo_priority | string | trim != "" -%}
priority={{ bp2itools_repo_priority }}
{% endif -%}

{% if (bp2itools_repo_proxy | trim) != "" -%}
proxy={{ bp2itools_repo_proxy }}
{% endif -%}

sslverify={{ 1 if (bp2itools_repo_sslverify | bool) else 0 }}
✅ Ça génère un fichier propre, et n’écrit les options que si elles sont définies.
handlers/main.yml
Copy code
Yaml
---
- name: Clean yum/dnf metadata
  ansible.builtin.command: "{{ item }}"
  changed_when: false
  loop:
    - "dnf -q clean metadata"
    - "yum -q clean metadata"
  failed_when: false
failed_when: false pour éviter d’échouer si dnf n’existe pas (RHEL7) ou si yum n’existe pas (images minimales RHEL8/9).
tasks/main.yml (check existence + non vide + template + notify handler)
Copy code
Yaml
---
- name: "Check if bp2itools repo file exists"
  ansible.builtin.stat:
    path: "{{ bp2itools_repo_path }}"
  register: bp2itools_repo_stat

- name: "Read repo file content (if exists)"
  ansible.builtin.slurp:
    path: "{{ bp2itools_repo_path }}"
  register: bp2itools_repo_slurp
  when: bp2itools_repo_stat.stat.exists

- name: "Decide if we must deploy repo (missing or empty)"
  ansible.builtin.set_fact:
    bp2itools_repo_need_deploy: >-
      {{
        (not bp2itools_repo_stat.stat.exists)
        or
        (
          bp2itools_repo_stat.stat.exists
          and
          (
            (bp2itools_repo_stat.stat.size | default(0) | int) == 0
            or
            ((bp2itools_repo_slurp.content | default('') | b64decode | trim) == '')
          )
        )
      }}

# Cas 1: le fichier n'existe pas ou est vide -> on force le déploiement
- name: "Deploy bp2itools.repo (missing/empty)"
  ansible.builtin.template:
    src: "bp2itools.repo.j2"
    dest: "{{ bp2itools_repo_path }}"
    owner: "{{ bp2itools_repo_owner }}"
    group: "{{ bp2itools_repo_group }}"
    mode: "{{ bp2itools_repo_mode }}"
  when: bp2itools_repo_need_deploy
  notify: Clean yum/dnf metadata

# Cas 2: le fichier existe et non vide -> on peut quand même garantir la conformité
# (si tu veux STRICT: toujours template pour converger, laisse ce bloc actif)
- name: "Ensure bp2itools.repo matches desired content (converge)"
  ansible.builtin.template:
    src: "bp2itools.repo.j2"
    dest: "{{ bp2itools_repo_path }}"
    owner: "{{ bp2itools_repo_owner }}"
    group: "{{ bp2itools_repo_group }}"
    mode: "{{ bp2itools_repo_mode }}"
  when: not bp2itools_repo_need_deploy
  notify: Clean yum/dnf metadata
Option “ne pas toucher si déjà non vide”
Si tu veux uniquement créer si absent/vide (et ne jamais écraser un repo existant même différent), alors supprime le bloc “converge” (le 2ᵉ template).
Si tu me donnes ton baseurl exact, si vous êtes en proxy, et si gpgcheck doit être activé (avec la vraie gpgkey), je te remplis le template avec vos valeurs “prod-ready”.