Parfait ğŸ‘
Avec les deux configurations complÃ¨tes des serveurs 30292 et 30295, on peut maintenant faire une analyse factuelle, expliquer pourquoi le comportement nâ€™est pas robuste, et donner la correction exacte RHEL 7.
Je vais Ãªtre trÃ¨s prÃ©cis.
ğŸ” 1ï¸âƒ£ Analyse DES CONFIGURATIONS ACTUELLES
ğŸ–¥ï¸ Serveur 30292
ğŸ”¹ ifcfg-bond0
Copy code
Ini
DEVICE=bond0
ONBOOT=yes
BOOTPROTO=none
IPADDR=10.xx.xx.33
NETMASK=255.255.255.192
GATEWAY=10.xx.xx.1
BONDING_OPTS="mode=1 miimon=100 primary_reselect=0"
NM_CONTROLLED=no
ğŸ”¹ Slaves
Copy code
Ini
ifcfg-pXp2:
  ONBOOT=no
  BOOTPROTO=dhcp   âŒ
  MASTER=bond0
  SLAVE=yes

ifcfg-pYp1:
  ONBOOT=no
  BOOTPROTO=dhcp   âŒ
  MASTER=bond0
  SLAVE=yes
ğŸ–¥ï¸ Serveur 30295
ğŸ”¹ ifcfg-bond0
Copy code
Ini
DEVICE=bond0
ONBOOT=yes
BOOTPROTO=none
IPADDR=10.xx.xx.34
NETMASK=255.255.255.192
GATEWAY=10.xx.xx.1
BONDING_OPTS="mode=1 miimon=100 primary_reselect=0"
NM_CONTROLLED=no
ğŸ”¹ Slaves
Copy code
Ini
ifcfg-pXp2:
  ONBOOT=no
  BOOTPROTO=none
  MASTER=bond0
  SLAVE=yes

ifcfg-p5Yp1:
  ONBOOT=no
  BOOTPROTO=none
  MASTER=bond0
  SLAVE=yes
ğŸš¨ 2ï¸âƒ£ PROBLÃˆMES CRITIQUES IDENTIFIÃ‰S
âŒ 1. fail_over_mac ABSENT (LES 2 SERVEURS)
ğŸ‘‰ Root cause principal de la perte SSH aprÃ¨s firmware
Par dÃ©faut (RHEL 7) :
la MAC du bond change lors du basculement
le switch peut bloquer le trafic
âŒ 2. ONBOOT=no sur les slaves (LES 2 SERVEURS)
ğŸ‘‰ Mauvaise pratique dangereuse
les slaves montent â€œpar chanceâ€
aprÃ¨s firmware â†’ timing diffÃ©rent â†’ esclaves non attachÃ©s
bond UP mais trafic instable
âŒ 3. BOOTPROTO=dhcp sur les slaves (30292)
ğŸ‘‰ ERREUR GRAVE
une carte slave ne doit JAMAIS avoir DHCP
peut gÃ©nÃ©rer :
requÃªtes DHCP parasites
MAC/VLAN incohÃ©rents
rejet switch
âŒ 4. primary_reselect=0 inutile ici
aucun primary=
option sans effet
confusion inutile
ğŸ§  ROOT CAUSE (CLAIRE ET DÃ‰FENDABLE)
Les deux serveurs ont une configuration bonding fonctionnelle mais non dÃ©terministe.
La mise Ã  jour firmware a dÃ©clenchÃ© un basculement de lâ€™interface active, provoquant un changement de MAC du bond.
Le switch nâ€™Ã©tant pas tolÃ©rant Ã  ce changement, le trafic (SSH inclus) a Ã©tÃ© bloquÃ©.
3ï¸âƒ£ CONFIGURATION CORRECTE (RHEL 7 â€“ GOLDEN CONFIG)
 A. Corriger ifcfg-bond0 (LES 2 SERVEURS)
Copy code
Ini
DEVICE=bond0
TYPE=Bond
BONDING_MASTER=yes
ONBOOT=yes
BOOTPROTO=none
IPADDR=10.14.xx.xx
PREFIX=26
GATEWAY=10.xx.xx.1
NM_CONTROLLED=no

BONDING_OPTS="mode=active-backup miimon=100 fail_over_mac=active"
ğŸ“Œ fail_over_mac=active = OBLIGATOIRE
ğŸ”§ B. Corriger les slaves (LES 2 SERVEURS)
Exemple ifcfg-pxp2 et ifcfg-pyp1
Copy code
Ini
DEVICE=pxp2
TYPE=Ethernet
ONBOOT=yes
BOOTPROTO=none
MASTER=bond0
SLAVE=yes
NM_CONTROLLED=no
âš ï¸ Supprimer toute ligne DHCP / IPv6 / DEFROUTE
ğŸ” 4ï¸âƒ£ Application SANS REBOOT
Copy code
Bash
ifdown pxp2 pyp1 bond0
ifup bond0
Puis vÃ©rifier :
Copy code
Bash
cat /proc/net/bonding/bond0
ip link show bond0
ğŸ§ª 5ï¸âƒ£ TEST OBLIGATOIRE (avant firmware)
Copy code
Bash
ifdown pxp2
ping -c 5 10.
ifup pxp2
âœ” Ping continu
âœ” MAC bond inchangÃ©e
âœ” SSH stable
ğŸ§¾ 6ï¸âƒ£ COMPARAISON EXPRESS 30292 vs 30295
Point
30292
30295
DHCP sur slaves
âŒ OUI
âœ” NON
ONBOOT slaves
âŒ NON
âŒ NON
fail_over_mac
âŒ
âŒ
Robustesse
âŒ
âŒ
Risque post-firmware
ğŸ”¥ Ã‰LEVÃ‰
ğŸ”¥ Ã‰LEVÃ‰
ğŸ¯ CONCLUSION FINALE
âœ” Le bonding fonctionne en apparence
âŒ La configuration nâ€™est pas robuste
âŒ Le firmware a juste rÃ©vÃ©lÃ© le problÃ¨me latent
ğŸ‘‰ Sans correction, lâ€™incident se reproduira
Si tu veux, je peux te fournir :
ğŸ“„ un diff exact prÃªt Ã  appliquer
ğŸ¤– un script bash de validation RHEL 7
ğŸ§¾ un rapport incident prÃªt pour CAB / manager
ğŸ”„ un plan de standardisation pour tous les serveurs
Dis-moi ğŸ‘