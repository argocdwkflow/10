D’après ta capture, la machine n’a pas de FQDN complet :
hostname = s02vl9947395
hostname -d = cpe.intra
Donc il faut arrêter de tester ansible_facts.fqdn.endswith(...) et tester le domaine (hostname -d), ce qui correspond à ansible_facts.domain.
Ce que tu dois changer dans ton projet
✅ À changer : roles/<ton_role>/tasks/main.yml
Dans ton tasks/main.yml, tu as ce bloc (vu sur tes captures) :
Copy code
Yaml
- name: Compute FQDN and CPE flag
  ansible.builtin.set_fact:
    bp2i_fqdn: "{{ (ansible_facts.fqdn | default(inventory_hostname)) | lower }}"
    bp2i_is_cpe: "{{ ((ansible_facts.fqdn | default(inventory_hostname)) | lower).endswith(bp2itools_cpe_suffix) }}"
➡️ Remplace-le par celui-ci (basé sur hostname -d) :
Copy code
Yaml
- name: Compute hostname/domain and CPE flag
  ansible.builtin.set_fact:
    bp2i_hostname: "{{ ansible_facts.hostname | default(inventory_hostname) | lower }}"
    bp2i_domain: "{{ ansible_facts.domain | default('') | lower }}"
    bp2i_is_cpe: "{{ (ansible_facts.domain | default('') | lower) == (bp2itools_cpe_suffix | lower) }}"
Ici ansible_facts.domain = sortie de hostname -d (dans ta capture : cpe.intra)
✅ À ajuster : defaults/main.yml
Dans ton defaults/main.yml, actuellement tu as :
Copy code
Yaml
bp2itools_cpe_suffix: ".cpe.intra"
➡️ Comme tu compares maintenant le domaine exact, change en :
Copy code
Yaml
bp2itools_cpe_suffix: "cpe.intra"
( sans point au début )
✅ Option “fallback” (si parfois FQDN existe)
Si certaines machines ont un vrai FQDN et d’autres non, utilise ce test (plus robuste) :
Copy code
Yaml
- name: Compute hostname/domain and CPE flag (domain first, fallback fqdn)
  ansible.builtin.set_fact:
    bp2i_hostname: "{{ ansible_facts.hostname | default(inventory_hostname) | lower }}"
    bp2i_domain: "{{ ansible_facts.domain | default('') | lower }}"
    bp2i_fqdn: "{{ ansible_facts.fqdn | default('') | lower }}"
    bp2i_is_cpe: >-
      {{
        (bp2i_domain == (bp2itools_cpe_suffix | lower))
        or
        (bp2i_fqdn.endswith('.' ~ (bp2itools_cpe_suffix | lower)))
      }}
Et dans defaults/main.yml, garde :
Copy code
Yaml
bp2itools_cpe_suffix: "cpe.intra"
Ce que tu ne changes PAS
templates/bp2itools.repo.j2 : inchangé
handlers/main.yml : inchangé
la sélection repo (ternary CPE vs standard) : inchangée
Si tu me dis le nom exact de ton rôle (ex: satellite_check_bp2itools_repo) je te redonne le tasks/main.yml complet final “copier-coller” avec ces modifications intégrées.