TrÃ¨s bien, la demande dâ€™Hubert est lÃ©gitime et tu peux la traiter de faÃ§on propre, experte et rassurante, sans entrer dans de la â€œbidouille awk/xargsâ€ non maÃ®trisÃ©e.
Je te propose la rÃ©ponse Ã  poster telle quelle, puis le plan technique derriÃ¨re.
âœ… RÃ©ponse courte Ã  Hubert (Ã  poster)
Oui, postsuper est bien la commande Ã  privilÃ©gier ğŸ‘
Pour Ã©viter toute suppression massive risquÃ©e, on peut effectivement faire du nettoyage ciblÃ© (par user ou destinataire) via postqueue + filtrage, mais lâ€™idÃ©e est surtout de corriger la source (crons) et dâ€™ajouter un monitoring prÃ©ventif pour ne plus avoir Ã  intervenir manuellement.
ğŸ› ï¸ Comment traiter techniquement la demande dâ€™Hubert
1ï¸âƒ£ Cas standard (recommandÃ©)
ğŸ‘‰ Purge globale contrÃ´lÃ©e
Copy code
Bash
postsuper -d ALL
âœ”ï¸ Simple
âœ”ï¸ SÃ»r
âœ”ï¸ AdaptÃ© quand les mails sont purement techniques (cron)
2ï¸âƒ£ Cas avancÃ© (demande Hubert : ciblage)
ğŸ”¹ Lister la queue
Copy code
Bash
postqueue -p
ğŸ”¹ Supprimer uniquement les mails envoyÃ©s par un user
Copy code
Bash
postqueue -p | awk '/^([A-F0-9])/{id=$1} /from=<user@/{print id}' | tr -d '*!' | postsuper -d -
ğŸ”¹ Supprimer les mails vers un destinataire prÃ©cis
Copy code
Bash
postqueue -p | awk '/^([A-F0-9])/{id=$1} /to=<dest@/{print id}' | tr -d '*!' | postsuper -d -
âš ï¸ Ã€ utiliser avec prudence, rÃ©servÃ© N3.
3ï¸âƒ£ Ce que tu peux ajouter pour cadrer (important)
On peut techniquement filtrer finement, mais ce nâ€™est pas la bonne stratÃ©gie long terme.
Le vrai correctif reste :
MAILTO=""
redirection stdout/stderr
monitoring /var/spool/postfix
ğŸ“Š Monitoring Dynatrace (pour clore le sujet)
Metric simple et robuste :
Copy code
Bash
du -sm /var/spool/postfix | awk '{print $1}'
â¡ï¸ Alerte avant saturation /var
â¡ï¸ IndÃ©pendant de lâ€™Ã©tat Postfix
â¡ï¸ Pas de spam dâ€™alertes
ğŸ¯ Phrase clÃ© pour conclure (expertise)
On sait nettoyer la queue finement si besoin, mais le vrai enjeu est dâ€™empÃªcher quâ€™elle se recrÃ©e.
Si tu veux, je peux aussi te prÃ©parer :
une rÃ©ponse ultra courte â€œOK Hubert + cadrageâ€
ou un runbook officiel N3 Postfix / cron
Tu es clairement dans la bonne posture ğŸ‘



Pour supprimer uniquement les mails destinÃ©s Ã  un user prÃ©cis dans la queue Postfix, lâ€™idÃ©e est :
extraire les Queue-ID correspondant au destinataire
les passer Ã  postsuper -d
âš ï¸ PrÃ©requis : postqueue -p doit fonctionner (sinon, on reste sur la purge disque / spool).
âœ… MÃ©thode 1 (simple, marche souvent) : filtrage sur les lignes â€œto=<â€¦>â€
Remplace user@domain.tld par ton destinataire :
Copy code
Bash
DEST="user@domain.tld"
postqueue -p | awk -v dest="$DEST" '
/^[A-F0-9]/{id=$1; gsub(/[*!]/,"",id)}
$0 ~ "to=<"dest">" {print id}
' | sort -u | postsuper -d -
sort -u Ã©vite les doublons
gsub(/[*!]/,"",id) retire */! Ã©ventuels dans lâ€™ID
âœ… MÃ©thode 2 (plus fiable) : utiliser postcat pour vÃ©rifier lâ€™enveloppe â€œTo:â€
Parce que postqueue -p ne montre pas toujours â€œto=<â€¦>â€ de maniÃ¨re exploitable.
1) Extraire les IDs (tous)
Copy code
Bash
postqueue -p | awk '/^[A-F0-9]/{id=$1; gsub(/[*!]/,"",id); print id}' | sort -u > /tmp/qids.txt
2) Garder uniquement ceux dont lâ€™enveloppe contient le destinataire
Copy code
Bash
DEST="user@domain.tld"
while read -r id; do
  postcat -q "$id" 2>/dev/null | grep -qiE "^To:.*\b${DEST}\b|^Original-Recipient:.*${DEST}|^Final-Recipient:.*${DEST}" \
    && echo "$id"
done < /tmp/qids.txt | postsuper -d -
âœ… Avantage : tu matches le mail rÃ©el (headers / recipients), pas seulement lâ€™affichage de postqueue.
âœ… Mode â€œdry-runâ€ (recommandÃ© avant de delete)
Pour voir ce qui serait supprimÃ© :
Copy code
Bash
DEST="user@domain.tld"
postqueue -p | awk -v dest="$DEST" '
/^[A-F0-9]/{id=$1; gsub(/[*!]/,"",id)}
$0 ~ "to=<"dest">" {print id}
' | sort -u
Quand câ€™est OK â†’ tu ajoutes | postsuper -d -
ğŸ§  Important (cas oÃ¹ Ã§a ne marche pas)
Si postqueue -p ne liste pas les to=<...> clairement (selon version/config), utilise MÃ©thode 2.
Si ton Postfix est â€œlocal-onlyâ€ et que le souci vient des crons, souvent le plus efficace est :
corriger crons (MAILTO="" + redirections)
purge globale si acceptable (postsuper -d ALL)
Si tu me donnes :
le format exact affichÃ© dans postqueue -p chez toi (3â€“5 lignes anonymisÃ©es)
et si câ€™est un user local (root, oracle) ou adresse mail complÃ¨te (user@...) je te donne la commande la plus fiable adaptÃ©e Ã  ton cas.