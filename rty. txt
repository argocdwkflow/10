Parfait üëç tu as raison et c‚Äôest une correction N3 tr√®s importante.
On ne doit PAS v√©rifier /var mais le filesystem qui porte le cache r√©el :
RHEL 7 ‚Üí /var/cache/yum
RHEL 8+ ‚Üí /var/cache/dnf
Je te donne UNIQUEMENT les actions √† modifier / ajouter, propres et robustes.
‚úÖ 1Ô∏è‚É£ D√©finir le bon chemin de cache selon l‚ÄôOS
Copy code
Yaml
- name: Set package manager cache path
  ansible.builtin.set_fact:
    pkg_cache_path: >-
      {{ '/var/cache/yum' if ansible_distribution_major_version | int == 7
         else '/var/cache/dnf' }}
‚úÖ 2Ô∏è‚É£ V√©rifier l‚Äôespace disque SUR LE BON PATH
Copy code
Yaml
- name: Check free space on package cache filesystem (KB)
  ansible.builtin.command: df -Pk {{ pkg_cache_path }}
  register: cache_df
  changed_when: false
‚úÖ 3Ô∏è‚É£ Extraire l‚Äôespace libre (int s√ªr)
Copy code
Yaml
- name: Set free cache space fact
  ansible.builtin.set_fact:
    pkg_cache_free_kb: "{{ (cache_df.stdout_lines[-1].split()[3]) | int }}"
‚úÖ 4Ô∏è‚É£ Bloquer proprement si < 500 MB
Copy code
Yaml
- name: Fail if package cache filesystem has less than 500MB free
  ansible.builtin.fail:
    msg: >-
      {{ pkg_cache_path }} filesystem is almost full
      ({{ pkg_cache_free_kb }} KB free) ‚Äì cannot run yum/dnf makecache
  when: (pkg_cache_free_kb | int) < 512000
üß† Pourquoi c‚Äôest la bonne impl√©mentation
Pas d‚Äôhypoth√®se sur /var
Fonctionne m√™me si /var/cache est sur un LV d√©di√©
Compatible RHEL 7 / 8 / 9
Z√©ro faux positif Satellite
üîÅ Rappel (inchang√©)
Tu gardes :
Copy code
Yaml
{{ ansible_pkg_mgr }} clean all
{{ ansible_pkg_mgr }} makecache
Si tu veux, je peux aussi te fournir :
üîπ une version sans set_fact
üîπ une version avec seuil param√©trable
üîπ une version block/rescue propre Satellite
Dis-moi üëç