Pour supprimer uniquement les mails destinÃ©s Ã  un user prÃ©cis dans la queue Postfix, lâ€™idÃ©e est :
extraire les Queue-ID correspondant au destinataire
les passer Ã  postsuper -d
âš ï¸ PrÃ©requis : postqueue -p doit fonctionner (sinon, on reste sur la purge disque / spool).
âœ… MÃ©thode 1 (simple, marche souvent) : filtrage sur les lignes â€œto=<â€¦>â€
Remplace user@domain.tld par ton destinataire :
Copy code
Bash
DEST="user@domain.tld"
postqueue -p | awk -v dest="$DEST" '
/^[A-F0-9]/{id=$1; gsub(/[*!]/,"",id)}
$0 ~ "to=<"dest">" {print id}
' | sort -u | postsuper -d -
sort -u Ã©vite les doublons
gsub(/[*!]/,"",id) retire */! Ã©ventuels dans lâ€™ID
âœ… MÃ©thode 2 (plus fiable) : utiliser postcat pour vÃ©rifier lâ€™enveloppe â€œTo:â€
Parce que postqueue -p ne montre pas toujours â€œto=<â€¦>â€ de maniÃ¨re exploitable.
1) Extraire les IDs (tous)
Copy code
Bash
postqueue -p | awk '/^[A-F0-9]/{id=$1; gsub(/[*!]/,"",id); print id}' | sort -u > /tmp/qids.txt
2) Garder uniquement ceux dont lâ€™enveloppe contient le destinataire
Copy code
Bash
DEST="user@domain.tld"
while read -r id; do
  postcat -q "$id" 2>/dev/null | grep -qiE "^To:.*\b${DEST}\b|^Original-Recipient:.*${DEST}|^Final-Recipient:.*${DEST}" \
    && echo "$id"
done < /tmp/qids.txt | postsuper -d -
âœ… Avantage : tu matches le mail rÃ©el (headers / recipients), pas seulement lâ€™affichage de postqueue.
âœ… Mode â€œdry-runâ€ (recommandÃ© avant de delete)
Pour voir ce qui serait supprimÃ© :
Copy code
Bash
DEST="user@domain.tld"
postqueue -p | awk -v dest="$DEST" '
/^[A-F0-9]/{id=$1; gsub(/[*!]/,"",id)}
$0 ~ "to=<"dest">" {print id}
' | sort -u
Quand câ€™est OK â†’ tu ajoutes | postsuper -d -
ğŸ§  Important (cas oÃ¹ Ã§a ne marche pas)
Si postqueue -p ne liste pas les to=<...> clairement (selon version/config), utilise MÃ©thode 2.
Si ton Postfix est â€œlocal-onlyâ€ et que le souci vient des crons, souvent le plus efficace est :
corriger crons (MAILTO="" + redirections)
purge globale si acceptable (postsuper -d ALL)
Si tu me donnes :
le format exact affichÃ© dans postqueue -p chez toi (3â€“5 lignes anonymisÃ©es)
et si câ€™est un user local (root, oracle) ou adresse mail complÃ¨te (user@...) je te donne la commande la plus fiable adaptÃ©e Ã  ton cas.